name: openEMS simulation (manual)

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      use_container:
        description: 'Build and run in a container (true/false)'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  smoke-test:
    name: Smoke test (placeholder)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install plotting deps (for placeholder graphs)
        run: |
          python -m pip install --upgrade pip
          pip install matplotlib

      - name: Run placeholder simulation
        run: |
          python openems/simulate_box.py --frequency-ghz 2.4 --output openems_results.json --preset xr-headset

      - name: Assert outputs exist
        run: |
          if [ ! -f openems_results.json ]; then echo "Missing JSON output" && exit 2; fi
          if [ ! -f openems_results.csv ]; then echo "Missing CSV sweep output" && exit 2; fi
          # Check for attenuation PNG (pattern)
          png=$(ls openems_results*attenuation*.png 2>/dev/null || true)
          if [ -z "$png" ]; then echo "Missing attenuation PNG (plot)" && exit 2; fi
          echo "Outputs present: $png"
      - name: Assert placeholder output
        run: |
          python - <<'PY'
import json,sys
with open('openems_results.json') as f:
    d=json.load(f)
if d.get('mode')!='placeholder':
    print('FAIL: mode != placeholder', d)
    sys.exit(2)
print('OK: placeholder output valid')
PY

  simulate-provisioned:
    name: Simulate on provisioned runner
    runs-on: [self-hosted, openems]
    if: ${{ github.event.inputs.use_container != 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run simulation (placeholder)
        run: |
          python3 openems/simulate_box.py

  simulate-container:
    name: Build container and simulate
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.use_container == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image (using docker CLI)
        run: |
          docker build -t github-faraday/openems:latest openems

      - name: Run simulation in container
        run: |
          docker run --rm -v "${{ github.workspace }}/openems:/work" github-faraday/openems:latest python3 openems/simulate_box.py

